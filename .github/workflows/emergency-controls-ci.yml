name: Emergency Controls CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  contract-tests:
    name: Sovereign Monetary Controls (Foundry)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Run Foundry Tests
        working-directory: contracts
        run: forge test --match-path test/SovereignMonetaryControls.t.sol -vvv

  api-integration-tests:
    name: Emergency Actions Integration (API)
    runs-on: ubuntu-latest
    needs: contract-tests
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: api/package.json

      - name: Install Dependencies
        working-directory: api
        run: npm ci

      - name: Run Emergency Integration Tests
        working-directory: api
        run: npm test test/emergency.test.ts
        env:
          NODE_ENV: test
          BLOCKCHAIN_RPC_URL: http://localhost:8545
          BLOCKCHAIN_CHAIN_ID: 31337
          CONTRACT_PERMISSIONING: 0x5FbDB2315678afecb367f032d93F642f64180aa3
          CONTRACT_WALLET_REGISTRY: 0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
          CONTRACT_TOKENIZED_EURO: 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
          CONTRACT_CONDITIONAL_PAYMENTS: 0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9
          JWT_SECRET: ci-test-secret-key-min-32-characters-long
